module TestAdiff
using Muscade
using Test,StaticArrays

const âˆ‚ğ•£11= âˆ‚â„{1,1,ğ•£}
const âˆ‚ğ•£12= âˆ‚â„{1,2,ğ•£}
const âˆ‚ğ•£22= âˆ‚â„{2,2,ğ•£}

## Constructors and promotion
dx1= âˆ‚â„{1,2}(3.,[.1,.2])
dx2= âˆ‚â„{1,2}(2.,[.3,.4])
dx3= âˆ‚â„{1,2}(4.,[.5,.6])
x  = âˆ‚â„{2,2}(dx1,[dx2,dx3])
a  = âˆ‚â„{2,2}(dx1,[1,2])
b  = âˆ‚â„{2,4}(dx1)
c  = âˆ‚â„{2,4}(dx1,3)
t1 = promote_rule(typeof(dx1),typeof(3))
t2 = promote_rule(typeof(dx1),typeof(x))
(d,e)=promote(dx1,7)
(g,h)=promote(dx1,x)

## Extraction
Î”   = Î´{1,2,ğ•£}()
C1  = variate{constants(Î”),2}([3.,4.])
C   = variate{constants(C1),2}(C1)
PC  = precedence(C)
PC1 = precedence(C1)
vC  = value{PC}(C)
âˆ‚C  = âˆ‚{PC,2}(  C)
vvC = value{PC1}(vC)
vâˆ‚C = value{PC1}(âˆ‚C)
âˆ‚vC = âˆ‚{PC1,2}(    vC)
#âˆ‚âˆ‚C = âˆ‚{PC1,2}(    âˆ‚C)
dX1 = toggle(false,dx1,3.)

## Operations
oa = variate{1,1}([1.])[1]
ob = variate{constants(oa   ),1}([2.])[1]
oc = variate{constants(oa,ob),1}([3.])[1]
od = oa+oc
oe = od+ob
oj = od^2
og = 2^od
oh = oa^oc
ok = oc*oa/oc
ox = [1.,2.,3.]
oX = variate{1,3}(ox)

## norm
using LinearAlgebra
nrm = norm(oX)

##
@testset "Adiff" begin
    @testset "Adiff construct and promote" begin
        @test dx1        â‰— âˆ‚ğ•£12(3.0, [0.1, 0.2])
        @test x          â‰— âˆ‚â„{2,2,âˆ‚ğ•£12}(âˆ‚ğ•£12(3.0, [0.1, 0.2]), [âˆ‚ğ•£12(2.0, [0.3, 0.4]), âˆ‚ğ•£12(4.0, [0.5, 0.6])])
        @test a          â‰— âˆ‚â„{2,2,âˆ‚ğ•£12}(âˆ‚ğ•£12(3.0, [0.1, 0.2]), [âˆ‚ğ•£12(1.0, [0.0, 0.0]), âˆ‚ğ•£12(2.0, [0.0, 0.0])])
        @test b          â‰— âˆ‚â„{2,4,âˆ‚ğ•£12}(âˆ‚ğ•£12(3.0, [0.1, 0.2]), [âˆ‚ğ•£12(0.0, [0.0, 0.0]), âˆ‚ğ•£12(0.0, [0.0, 0.0]), âˆ‚ğ•£12(0.0, [0.0, 0.0]), âˆ‚ğ•£12(0.0, [0.0, 0.0])])
        @test c          â‰— âˆ‚â„{2,4,âˆ‚ğ•£12}(âˆ‚ğ•£12(3.0, [0.1, 0.2]), [âˆ‚ğ•£12(0.0, [0.0, 0.0]), âˆ‚ğ•£12(0.0, [0.0, 0.0]), âˆ‚ğ•£12(1.0, [0.0, 0.0]), âˆ‚ğ•£12(0.0, [0.0, 0.0])])
        @test t1         == âˆ‚ğ•£12
        @test t2         ==âˆ‚â„{2,2,âˆ‚ğ•£12}
        @test d          â‰— dx1
        @test e          â‰— âˆ‚ğ•£12(7.0, [0.0, 0.0])
        @test typeof(g) == âˆ‚â„{2,2,âˆ‚ğ•£12}
        @test g         â‰— âˆ‚â„{2,2,âˆ‚ğ•£12}(âˆ‚ğ•£12(3.0, [0.0, 0.0]), [âˆ‚ğ•£12(0.1, [0.0, 0.0]), âˆ‚ğ•£12(0.2, [0.0, 0.0])])
        @test h          â‰— x
    end

    @testset "Adiff extraction" begin
        @test Î”            â‰— [âˆ‚ğ•£12(0.0, [1.0, 0.0]),âˆ‚ğ•£12(0.0, [0.0, 1.0])]
        @test constants(Î”) â‰— 2
        @test typeof(C)    == SVector{2, âˆ‚â„{3, 2, âˆ‚â„{2, 2, Float64}}}#Array{âˆ‚â„{3,2,âˆ‚ğ•£22},1}
        @test C[1]         â‰— âˆ‚â„{3,2,âˆ‚ğ•£22}(âˆ‚ğ•£22(3.0, SVector(1.0, 0.0)), SVector(âˆ‚ğ•£22(1.0, [0.0, 0.0]), âˆ‚ğ•£22(0.0, [0.0, 0.0])))
        @test vC[1]        â‰— âˆ‚ğ•£22(3.0, [1.0, 0.0])
        @test âˆ‚C[1]        â‰— âˆ‚ğ•£22(1.0, [0.0, 0.0])
        @test vvC          â‰— [3.0,4.0]
        @test vâˆ‚C          â‰— [1.0 0.0;0.0 1.0]
        @test âˆ‚vC          â‰— âˆ‚vC
#        @test âˆ‚âˆ‚C          â‰— zeros(2,2,2)   broken=true # extract partial derivatives of an SMatrix or higher order
        @test typeof(dX1)  == âˆ‚ğ•£12
    end

    @testset "Adiff operations" begin
        @test oa â‰— âˆ‚ğ•£11(1.0, [1.0])
        @test ob â‰— âˆ‚â„{2,1,ğ•£}(2, [1])
        @test oc â‰— âˆ‚â„{3,1,ğ•£}(3.0, [1.0])
        @test od â‰— âˆ‚â„{3,1,âˆ‚ğ•£11}(âˆ‚ğ•£11(4.0, [1.0]), âˆ‚ğ•£11[âˆ‚ğ•£11(1.0, [0.0])])
        @test oe â‰— âˆ‚â„{3,1,âˆ‚â„{2,1,âˆ‚ğ•£11}}(âˆ‚â„{2,1,âˆ‚ğ•£11}(âˆ‚ğ•£11(6.0, [1.0]), [âˆ‚ğ•£11(1.0, [0.0])]), âˆ‚â„{2,1,âˆ‚ğ•£11}[âˆ‚â„{2,1,âˆ‚ğ•£11}(âˆ‚ğ•£11(1.0, [0.0]), [âˆ‚ğ•£11(0.0, [0.0])])])
        @test od â‰— âˆ‚â„{3,1,âˆ‚ğ•£11}(âˆ‚ğ•£11(4.0, [1.0]), âˆ‚ğ•£11[âˆ‚ğ•£11(1.0, [0.0])])
        @test og â‰— âˆ‚â„{3,1,âˆ‚ğ•£11}(âˆ‚ğ•£11(16.0, [11.090354888959125]), âˆ‚ğ•£11[âˆ‚ğ•£11(11.090354888959125, [7.687248222691222])])
        @test oj â‰— od*od
        @test og â‰— âˆ‚â„{3,1,âˆ‚ğ•£11}(âˆ‚ğ•£11(16.0, [11.090354888959125]), âˆ‚ğ•£11[âˆ‚ğ•£11(11.090354888959125, [7.687248222691222])])
        @test ok â‰— âˆ‚â„{3,1,âˆ‚ğ•£11}(âˆ‚ğ•£11(1.0, [1.0]), [âˆ‚ğ•£11(0.0, [0.0])])
        @test value{1}(2*oX)==2*ox
    end


    @testset " norm" begin
        @test nrm â‰— sqrt(sum(oX.^2))
    end
end # testset Adiff
end
